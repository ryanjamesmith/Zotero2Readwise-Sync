name: Zotero → Readwise Sync

on:
  schedule:
    - cron: "0 7 * * *"  # every day at 07:00 UTC (midnight PT)
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install zotero2readwise
        run: |
          python -m pip install --upgrade pip
          pip install zotero2readwise

      - name: Run Zotero → Readwise Sync
        env:
          READWISE_TOKEN: ${{ secrets.READWISE_TOKEN }}
          ZOTERO_KEY:     ${{ secrets.ZOTERO_KEY }}
          ZOTERO_ID:      ${{ secrets.ZOTERO_ID }}
        run: |
          python - <<'PY'
          import os
          from zotero2readwise.zt2rw import Zotero2Readwise

          z = Zotero2Readwise(
              readwise_token=os.environ["READWISE_TOKEN"],
              zotero_key=os.environ["ZOTERO_KEY"],
              zotero_library_id=os.environ["ZOTERO_ID"],
              zotero_library_type="user",
              include_annotations=True,
              include_notes=True,
          )

          # OPTIONAL: attach Zotero Citation Key from the "extra" field
          try:
              all_items = z.retrieve_all("annotation", z.since)
              for item in all_items:
                  extra = item["data"].get("extra", "")
                  if "Citation Key:" in extra:
                      key = extra.split("Citation Key:")[-1].strip()
                      item["data"]["citation_key"] = key
          except Exception as e:
              print(f"Could not inject citation keys: {e}")

          print("Syncing…")
          z.run()
          print("✅ Done.")
          PY
