name: Zotero to Readwise Automation

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install zotero2readwise
        run: |
          pip install --upgrade pip
          pip install zotero2readwise

      - name: Sync Zotero â†’ Readwise (use @citationkey as title)
        env:
          READWISE_TOKEN: ${{ secrets.READWISE_TOKEN }}
          ZOTERO_KEY: ${{ secrets.ZOTERO_KEY }}
          ZOTERO_ID: ${{ secrets.ZOTERO_ID }}
        run: |
          python - <<'PY'
          import os, re
          from zotero2readwise.zt2rw import Zotero2Readwise

          z = Zotero2Readwise(
              readwise_token=os.environ["READWISE_TOKEN"],
              zotero_key=os.environ["ZOTERO_KEY"],
              zotero_library_id=os.environ["ZOTERO_ID"],
              zotero_library_type="user",
              include_annotations=True,
              include_notes=True,
          )

          print("ðŸ”§ Custom title rewrite: start")

          anns = z.retrieve_all("annotation", z.since)
          notes = z.retrieve_all("note", z.since)
          items = anns + notes
          print(f"   â€¢ Retrieved {len(items)} Zotero items")

          changed = 0
          for it in items:
              d = it.get("data", {})
              extra = (d.get("extra") or "")
              m = re.search(r"(?i)Citation\s*Key\s*:\s*(\S+)", extra)
              if m:
                  key = m.group(1).strip()
                  if key:
                      d["title"] = f"@{key}"
                      changed += 1

          print(f"   â€¢ Titles changed to @citationkey on {changed} items")
          formatted = z.formatter.format_items(items)
          print("   â€¢ Uploading to Readwiseâ€¦")
          z.readwise.post_zotero_annotations_to_readwise(formatted)

          print("âœ… Done. (@citationkey titles applied where available)")
          PY
